---
title: "SPatial Age Structued Model"
author: "Dan Ovando"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Background

# Examples

## Simple MPA Example

```{r}
library(tidyverse)
library(FishLife)
library(spasm)
library(ggridges)
library(gganimate)


fish <-
  create_fish(
    scientific_name = "Atractoscion nobilis",
    query_fishlife = T,
    mat_mode = "length",
    time_step = 1,
    sigma_r = 0,
    steepness = 0.9,
    r0 = 4290000,
    rec_ac = 0,
    adult_movement = 0,
    larval_movement = 0,
    density_dependence_form = 1
  )


fleet <- create_fleet(
  fish = fish,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.1 * fish$linf,
  initial_effort = 2000,
  profit_lags =  5,
  beta = 2,
  max_cp_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'simple'
)


simple <- spasm::sim_fishery(
  fish = fish,
  fleet = fleet,
  manager = create_manager(mpa_size = 0.2, year_mpa = 25),
  num_patches = 100,
  sim_years = 50,
  burn_year = 1,
  time_step = fish$time_step,
  est_msy = T,
  random_mpas = FALSE,
  min_size = 0.05,
  mpa_habfactor = 1,
  sprinkler = FALSE,
  keep_burn = FALSE
)

simple %>%
  group_by(year, patch) %>%
  summarise(te = sum(effort),
            profits = sum(profits),
            biomass = sum(biomass)) %>%
  ungroup() %>%
  mutate(ppue = profits / te) %>%
  gather(metric, value, -year,-patch) %>%
  ggplot(aes(year, value, color = factor(patch))) +
  geom_line(show.legend = F) +
  facet_wrap(~metric, scales = "free_y")

```



## Complext MPA Example

```{r}
library(tidyverse)
library(FishLife)
library(spasm)
library(ggridges)
library(gganimate)


fish <-
  create_fish(
    scientific_name = "Atractoscion nobilis",
    query_fishlife = T,
    mat_mode = "length",
    time_step = 1,
    sigma_r = 0,
    steepness = 0.9,
    r0 = 4290000,
    rec_ac = 0,
    density_movement_modifier = 0.1,
    adult_movement = 10,
    larval_movement = 30,
    density_dependence_form = 3
  )


fleet <- create_fleet(
  fish = fish,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "constant-effort",
  sigma_effort = 0,
  length_50_sel = 0.1 * fish$linf,
  initial_effort = 2000,
  profit_lags =  5,
  beta = 2,
  max_cp_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'gravity'
)


complex <- spasm::sim_fishery(
  fish = fish,
  fleet = fleet,
  manager = create_manager(mpa_size = 0.2, year_mpa = 25),
  num_patches = 100,
  sim_years = 50,
  burn_year = 25,
  time_step = fish$time_step,
  est_msy = T,
  random_mpas = TRUE,
  min_size = 0.05,
  mpa_habfactor = 2,
  sprinkler = TRUE,
  keep_burn = FALSE
)

complex %>%
  group_by(year, patch) %>%
  summarise(te = sum(effort),
            profits = sum(profits),
            biomass = sum(biomass)) %>%
  ungroup() %>%
  mutate(ppue = profits / te) %>%
  gather(metric, value, -year,-patch) %>%
  ggplot(aes(year, value, color = factor(patch))) +
  geom_line(show.legend = F) +
  facet_wrap(~metric, scales = "free_y")

```


## MPAs + Fleet Dynamics


```{r}
fish <-
  create_fish(
    scientific_name = "Atractoscion nobilis",
    query_fishlife = T,
    mat_mode = "length",
    time_step = 1,
    sigma_r = 0,
    price = 10,
    price_cv = 0,
    price_ac = 0,
    price_slope = 0,
    steepness = 0.9,
    r0 = 4290000,
    rec_ac = 0,
    density_movement_modifier = 0,
    adult_movement = 3,
    larval_movement = 3,
    density_dependence_form = 3
  )


fleet <- create_fleet(
  fish = fish,
  cost_cv =  0,
  cost_ac = 0,
  cost_slope = 0,
  q_cv = 0,
  q_ac = .7,
  q_slope = 0,
  fleet_model = "open-access",
  sigma_effort = 0,
  length_50_sel = 0.1 * fish$linf,
  initial_effort = 200,
  profit_lags =  5,
  beta = 2,
  max_cp_ratio = 0.9,
  max_perc_change_f = 0.5,
  effort_allocation = 'profit-gravity'
)


complex_fleet <- spasm::sim_fishery(
  fish = fish,
  fleet = fleet,
  manager = create_manager(mpa_size = 0.4, year_mpa = 30),
  num_patches = 20,
  sim_years = 100,
  burn_year = 50,
  time_step = fish$time_step,
  est_msy = T,
  random_mpas = TRUE,
  min_size = 0.05,
  mpa_habfactor = 2,
  sprinkler = TRUE,
  keep_burn = FALSE
)

complex_fleet %>%
  group_by(year, patch) %>%
  summarise(te = sum(effort),
            profits = sum(profits),
            biomass = sum(biomass)) %>%
  ungroup() %>%
  mutate(ppue = profits / te) %>%
  gather(metric, value, -year,-patch) %>%
  ggplot(aes(year, value, color = factor(patch))) +
  geom_line(show.legend = F) +
  facet_wrap(~metric, scales = "free_y")

```



Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
